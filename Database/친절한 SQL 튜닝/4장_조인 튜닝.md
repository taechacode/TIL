# 4장 조인 튜닝


## 4.1 NL 조인


### 4.1.1 기본 메커니즘
- NL 조인은 중첩 루프문과 같은 수행 구조를 사용한다.
- 일반적으로 NL 조인은 Outer와 Inner 양쪽 테이블 모두 인덱스를 이용한다.
- Outer 쪽 테이블은 사이즈가 크지 않으면 인덱스를 이용하지 않을 수 있다. Table Full Scan 하더라도 그것은 한 번에 그치기 때문이다.
- 반면, Inner 쪽 테이블은 인덱스를 사용해야한다. Inner 루프에서 데이터를 검색할 때 인덱스를 이용하지 않으면, Outer 루프에서 읽은 건수만큼 Table Full Scan을 반복하기 때문이다.


### 4.1.2 NL 조인 실행계획 제어
- `ordered` 힌트는 FROM 절에 기술한 순서대로 조인하라고 옵티마이저에 지시할 때 사용한다. `ordered` 대신 `leading` 힌트를 사용할 수도 있다. 이 힌트를 사용하면 FROM 절을 바꾸지 않고 순서를 제어할 수 있어 편리하다.
- `use_nl` 힌트는 NL 방식으로 조인하라고 지시할 때 사용한다.
- `index` 힌트는 인덱스를 이용해서 액세스하라고 지시할 때 사용한다. 인덱스명을 명시하지 않으면 어떤 인덱스를 사용할지는 옵티마이저가 결정한다.


### 4.1.3 NL 조인 수행 과정 분석
```
SELECT /*+ ordered use_nl(C) index(E) index(C) */
FROM 사원 E, 고객 C
WHERE C.관리사원번호 = E.사원번호
AND   E.입사일자 >= '19960101'
AND   E.부서코드 = 'Z123'
AND   C.최종주문금액 >= 20000
```
```
* 사원_PK : 사원번호
* 사원_X1 : 입사일자
* 고객_PK : 고객번호
* 고객_X1 : 관리사원번호
* 고객_X2 : 최종주문금액
```

### 4.1.4 NL 조인 튜닝 포인트
- 첫 번째 튜닝 포인트는 사원_X1 인덱스를 읽고 나서 사원 테이블을 액세스하는 부분이다. 여기서는 단일 컬럼 액세스를 `>=` 조건으로 스캔했으므로 비효율 없이 6(=5+1)건을 읽었고, 그만큼 테이블 랜덤 액세스가 발생했다.
- 만약 사원 테이블로 아주 많은 양의 랜덤 액세스가 발생했고, 테이블에서 부서코드 = 'Z123' 조건에 의해 필터링되는 비율이 높다면 어떻게 해야 할까? 사원_X1 인덱스에 부서코드 컬럼을 추가하는 방안을 고려해야 한다.
- 두 번째 튜닝 포인트는 고객_X1 인덱스를 탐색하는 부분이다. 고객_X1 인덱스를 탐색하는 횟수, 즉 조인 액세스 횟수가 많을수록 성능이 느려진다. 조인 액세스 횟수는 Outer 테이블인 사원을 읽고 필터링한 결과 건수에 의해 결정된다.
- 만약 부서코드 조건을 만족하는 레코드가 10만 건이고 고객_X1 인덱스 Depth가 3이라면 인덱스 수직적 탐색 과정에서만 30만(=10만x3)개 블록을 읽어야 하고, 리프 블록을 수평적으로 스캔하는 과정에서 추가적인 블록I/O가 더해진다.
- 세 번째 튜닝 포인트는 고객_X1 인덱스를 읽고 나서 고객 테이블을 액세스하는 부분이다. 여기서도 최종주문금액 >= 20000 조건에 의해 필터링되는 비율이 높다면 고객_X1 인덱스에 최종주문금액 컬럼을 추가하는 방안을 고려해야 한다.
- 마지막으로, 맨 처음 액세스하는 사원_X1 인덱스에서 얻은 결과 건수에 의해 전체 일량이 좌우된다. 사원_X1 인덱스를 스캔하면서 추출한 레코드가 많으면, 사원 테이블로 랜덤 액세스하는 횟수, 고객_X1 인덱스를 탐색하는 횟수, 고객 테이블로 랜덤 액세스하는 횟수가 전반적으로 많아진다.

#### 올바른 조인 메소드 선택
- 온라인 트랜잭션 처리(OLTP) 시스템에서 튜닝할 때는 일차적으로 NL 조인부터 고려하는 것이 올바른 순서다.
- 성능이 느리다면, NL 조인 튜닝 포인트에 따라 각 단계의 수행 일량을 분석해서 과도한 랜덤 액세스가 발생하는 지점을 우선 파악한다. 조인 순서를 변경해서 랜덤 액세스 발생량을 줄일 수 있는지, 더 효과적인 다른 인덱스가 있는지 등을 검토한다. 필요하다면, 인덱스 추가 또는 구성 변경도 고려해 본다.
- 여러 방안을 검토한 결과 NL 조인으로 결코 좋은 성능을 내기 어렵다고 판단될 때, 소트 머지 조인이나 해시 조인을 검토한다.


### 4.1.5 NL 조인 특징 요약
- NL 조인의 첫 번째 특징은 `랜덤 액세스 위주`의 조인 방식이라는 점이다. 레코드 하나를 읽으려고 블록을 통째로 읽는 랜덤 액세스 방식은 설령 메모리 버퍼에서 빠르게 읽더라도 비효율이 존재한다.
- 두 번째 특징은 조인을 `한 레코드씩 순차적으로 진행`한다는 점이다. 첫 번째 특징 때문에 대량 데이터 처리 시 매우 치명적인 한계를 드러내지만, 반대로 부분범위 처리가 가능한 상황에서 이 두 번째 특징 때문에 아무리 큰 테이블을 조인하더라도 매우 빠른 응답 속도를 낼 수 있다.
- 순차적으로 진행하므로 먼저 액세스되는 테이블 처리 범위에 의해 전체 일량이 결정되는 특징도 나타난다.
- 마지막으로, 다른 조인 방식과 비교할 때 `인덱스 구성 전략이 특히 중요`하다는 것도 NL조인의 중요한 특징이다. 조인 컬럼에 대한 인덱스가 있느냐 없느냐, 있다면 컬럼이 어떻게 구성 됐느냐에 따라 조인 효율이 크게 달라진다.
- 위의 여러 가지 특징들을 종합할 때, NL 조인은 소량 데이터를 주로 처리하거나 부분범위 처리가 가능한 `온라인 트랜잭션 처리(OLTP) 시스템에 적합`한 조인 방식이라고 할 수 있다.


### 4.1.6 NL 조인 튜닝 실습