# 5장 소트 튜닝

## 5.1 소트 연산에 대한 이해

### 5.1.1 소트 수행 과정
- 소트는 기본적으로 PGA에 할당한 Sort Area에서 이루어지며, Sort Area에서 작업을 완료할 수 있는지에 따라 두 가지 유형으로 나눈다.
    - 메모리 소트(In-Memory Sort) : 전체 데이터의 정렬 작업을 메모리 내에서 완료하는 것을 말하며 `Internal Sort`라고도 한다.
    - 디스크 소트(Disk Sort) : 할당받은 Sort Area 내에서 정렬을 완료하지 못해 디스크 공간까지 사용하는 경우를 말하며, `External Sort`라고도 한다.

### 5.1.2 소트 오퍼레이션

#### (1) Sort Aggregate
- Sort Aggregate는 전체 로우를 대상으로 집계를 수행할 때 나타난다. 'Sort'라는 표현을 사용하지만, 실제로 데이터를 정렬하진 않는다.

#### (2) Sort Order By

#### (3) Sort Group By
- 소팅 알고리즘을 사용해 그룹별 집계를 수행할 때 나타난다.

#### (4) Sort Unique

#### (5) Sort Join

#### (6) Window Sort

## 5.2 소트가 발생하지 않도록 SQL 작성

### 5.2.1 Union vs. Union All

### 5.2.2 Exists 활용

## 5.3 인덱스를 이용한 소트 연산 생략
- 인덱스는 항상 키 컬럼 순으로 정렬된 상태를 유지한다. 이를 활용하면 SQL에 Order By 또는 Group By 절이 있어도 소트 연산을 생략할 수 있다. 여기에 Top N 쿼리 특성을 결합하면, 온라인 트랜잭션 처리 시스템에서 대량 데이터를 조회할 때 매우 빠른 응답 속도를 낼 수 있다. 특정 조건을 만족하는 최소값 또는 최대값도 빨리 찾을 수 있어 이력 데이터를 조회할 때 매우 유용하다.

### 5.3.1 Sort Order By 생략

### 5.3.2 Top N 쿼리
- Top N 쿼리는 전체 결과집합 중 상위 N개 레코드만 선택하는 쿼리다.
- `COUNT(STOPKEY)`는 조건절에 부합하는 레코드가 아무리 많아도 그 중 ROWNUM으로 지정한 건수만큼 결과 레코드를 얻으면 거기서 바로 멈춘다는 뜻이다. -> `Top N Stopkey 알고리즘`
- `부분범위 처리 가능하도록 SQL을 작성한다`는 의미는 무엇일까? 인덱스 사용 가능하도록 조건절을 구사하고, 조인은 NL 조인 위주로 처리(룩업을 위한 작은 테이블은 해시 조인 Build Input으로 처리해도 됨)하고, Order By 절이 있어도 소트 연산을 생략할 수 있도록 인덱스를 구성해 주는 것을 의미한다.

### 5.3.3 최소값/최대값 구하기
- Sort Aggregate는 전체 데이터를 정렬하진 않지만, 전체 데이터를 읽으면서 값을 비교한다. (SUM, MAX, MIN, AVG 등을 구하기 위해)
- 인덱스를 정렬돼 있으므로 이를 이용하면 전체 데이터를 읽지 않고도 최소 또는 최대값을 쉽게 찾을 수 있다. 인덱스 맨 왼쪽으로 내려가서 첫 번째 읽는 값이 최소값이고, 맨 오른쪽으로 내려가서 첫 번째 읽는 값이 최대값이다.

#### 인덱스 이용해 최소/최대값 구하기 위한 조건
- 전체 데이터를 읽지 않고 인덱스를 이용해 최소 또는 최대값을 구하려면, 조건절 컬럼과 MIN/MAX 함수 인자 컬럼이 모두 인덱스에 포함돼 있어야 한다.
- 실행계획에서 `FIRST ROW`는 조건을 만족하는 레코드 하나를 찾았을 때 바로 멈춘다는 것을 의미한다. (`First Row Stopkey` 알고리즘)